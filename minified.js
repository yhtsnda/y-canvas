function Global(){return window}function addEventHandler(a,b,c){a&&(b&&c)&&(a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent?a.attachEvent("on"+b,eval(c)):a["on"+b]=c)}function singleton(a){var b;return void 0!==b?b:function(){return b=a()}}
function domReady(a){if(!("onreadystatechange"in document)||!("readystatechange"in document))var b=setTimeout(function(){clearTimeout(b);"complete"===document.readyState||"loaded"===document.readyState?a&&a():b=setTimeout(arguments.callee,50)},50);else addEventHandler(document,"readystatechange",function(){("complete"===this.readyState||"loaded"===this.readyState)&&a&&a()})}
var requestAnimFrame=function(){return Global().requestAnimationFrame||Global().webkitRequestAnimationFrame||Global().mozRequestAnimationFrame||Global().oRequestAnimationFrame||Global().msRequestAnimationFrame||function(a){Global().setTimeout(a,Math.round(1E3/60))}}(),cancelAnimationFrame=function(){return Global().cancelAnimationFrame||Global().webkitCancelRequestAnimationFrame||Global().mozCancelRequestAnimationFrame||Global().oCancelRequestAnimationFrame||Global().msCancelRequestAnimationFram||
clearTimeout}(),setTimeRequest=function(a,b){if(0==b)a&&a();else var c=0,d=Global().requestAnimFrame(function(){c++;Global().cancelAnimationFrame(d);c==b?a&&a():d=Global().requestAnimFrame(arguments.callee)})};var Debugger=Global().console||{debug:function(){},info:function(){},warn:function(){},assert:function(){},error:function(a){throw Error(a);}};Array.prototype.removeNullVal=function(){for(var a=this.length-1;0<=a;a--)(void 0===this[a]||null===this[a])&&this.splice(a,1);return this};function getResolution(){return SizeMake(document.documentElement.offsetWidth,document.documentElement.body)}function device(){return{resolution:getResolution()}}var Device=singleton(device);function BaseObject(){}BaseObject.prototype.publish=function(a){MessageCenter.onPublish(a)};BaseObject.prototype.subscribe=function(a,b){MessageCenter.onSubscribe(a,b,this)};BaseObject.prototype.unSubscribe=function(a,b){MessageCenter.onUnSubscribe(this,a,b)};
BaseObject.prototype.exec=function(a){if(this&&this[a])if(2===arguments.length&&"[object Arguments]"===Object.prototype.toString.call(arguments[1]))this[a].apply(this,arguments[1]);else if(1<arguments.length)this[a].apply(this,Array.prototype.slice.call(arguments,1));else this[a]()};BaseObject.prototype.execB=function(a,b){return this&&this[a]&&this[a].apply(this,b)};function mixIn(a,b,c){if(c){for(var d in b)a[d]=b[d];return a}c={};for(d in a)c[d]=a[d];for(d in b)c[d]=b[d];return c}function forEach(a,b,c){if(!(void 0===a||null===a))if(void 0!==a.length)for(var d=0;d<a.length;d++){if(!0===b.call(c||Global(),a[d],d,a))return!0}else for(d in a)if(!0===b.call(c||Global(),a[d],d,a))return!0}
function currying(a,b,c,d){(d||this)[b]=function(b,d){if(!(null===b||void 0===b))return 1<arguments.length?c[a].apply(b,Array.prototype.slice.call(arguments,1)):c[a].call(b)}}forEach("push pop slice splice concat shift unshift sort reverse join".split(" "),function(a){currying(a,a,Array.prototype)});currying("toString","toStr",Object.prototype);forEach(["apply","call"],function(a){currying(a,a,Function.prototype)});
forEach("Array Object Function Arguments Number Date Boolean String RegExp".split(" "),function(a){Global()["is"+a]=function(b){return toStr(b)==="[object "+a+"]"}});currying("exec","exec",BaseObject.prototype);function setCallback(a){this.callback=this.callback||[];if(a)if(isArray(a)){var b=this;forEach(a,function(a){a&&b.callback.push(a)})}else this.callback.push(a)}function emitCallback(){var a=this;forEach(a.callback,function(b){b&&b.call(a)});a.callback=[]}
function prop(a){var b=a;return function(a){return void 0===a?b:b=a}};function Node(){this.position=prop(PointMake(0,0));this.actualPosition=function(){return this.position()};this.rect=prop(PointMake(0,0));this.visible=prop(!1);this.display=prop(!0);this.images=prop([]);this.imageSizes=prop([]);this.imageIndex=prop(0);this.getImage=function(){return this.images()[this.imageIndex()]};this.zIndex=prop(0);this.alpha=prop(1);this.anchor=prop(PointMake(0.5,0.5));this.rotate=prop(0);this.scale=prop(PointMake(1,1));this.skew=prop(PointMake(0,0));this.transform=prop();this.pause=
prop();this.stop=function(){this.pause(!0)};this.resume=function(){this.pause(!1)};this.children=prop([]);this.childrenWithoutEmpty=function(){return this.children()&&this.children().removeNullVal()};this.resetChildren=function(){return this.children([])};this.clearChildren=function(){return this.children(null)};this.getChildByTag=function(){for(var a=this.children(),c=0;c<a.length;c++)if(a[c]&&a[c].tag==tag)return a[c]};this.addChild=function(a){return this.children().push(a),this.children()};this.removeLastChild=
function(){return this.children().pop(),this.children()};this.updateChildren=function(a){var c=this.children();c.sort(function(a,b){return b.index-a.index});for(var d=c.length,e=d-1;0<=e;e--)null===c[e]||c[e].destoryed?(d--,c[e]=c[d]):c[e].update(a);c.length=d};this.width=prop(0);this.height=prop(0);this.actionManager=new ActionManager(this);var a=this;forEach("mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave keydown keypress keyup touchstart touchmove touchend touchcancel".split(" "),
function(b){a["on"+b]=[]});this.handleEvents=function(){};this.runAction=function(){exec(this.actionManager,"runAction",arguments)};arguments.length?exec(this,"init",arguments):exec(this,"init")};function getContext(){return Global().app.getContext()}function getDom(){return Global().app.dom}function Application(){this.init.apply(this,arguments)}Application.prototype=new BaseObject;Application.prototype.init=function(a){this.dom=a;this.nextScene=this.currentScene=null;this.scenes=[];Global().app=this};Application.prototype.getContext=function(){return this.dom.getContext(this.supportOpenGLES()?"opengles":"2d")};Application.prototype.supportOpenGLES=function(){return!1};
Application.prototype.run=function(){this.resume();EventSystem.init();this.update(this.getContext())};Application.prototype.pause=function(a){void 0!=a?(exec(this.currentScene,"pause",a),exec(this.nextScene,"pause",a),a=this._paused=a):a=this._paused;return a};Application.prototype.stop=function(){this.pause(!0)};Application.prototype.resume=function(){this.pause(!1)};Application.prototype.clear=function(){exec(this.currentScene,"clear");exec(this.nextScene,"clear");this.clear()};
Application.prototype.update=function(a){var b=this;b.handleEvents();this.clearCanvas(a);exec(b.currentScene,"update",a);exec(b.nextScene,"update",a);b.resetEvents();b.showFPS(a);requestAnimFrame(function(){b.update(a)})};Application.prototype.clearCanvas=function(a){a.clearRect(0,0,this.dom.width,this.dom.height)};
Application.prototype.showFPS=function(a){this._currentFrameCount=this._currentFrameCount||0;if(0===this._currentFrameCount%10){var b=(new Date).valueOf();this._lastDate&&(this._fpsText=Math.round(1E5/(b-this._lastDate))/10);this._lastDate=b}this._fpsText&&(a.save(),a.fillStyle="#589B2A",a.font="30px sans-serif bold",a.fillText(this._fpsText,this.dom.width/2,30),a.restore());this._currentFrameCount++};Application.prototype.handleEvents=function(){EventSystem.deallingEvents(!0)};
Application.prototype.resetEvents=function(){EventSystem.deallingEvents(!1);EventSystem.resetEvents()};Application.prototype.clear=function(){Debugger.error("Could add code to implement Application's clear function")};function Scene(){Node.apply(this,arguments)}Scene.prototype=new BaseObject;Scene.prototype.init=function(){this.exec("onInit",arguments);this.exec("_init",arguments);this.exec("afterInit",arguments)};Scene.prototype.clear=function(){this.exec("onClear",arguments);this.unSubscribe();this.clearLayers();for(var a in this)delete this[a];this.exec("_clear",arguments);this.exec("afterClear",arguments)};
Scene.prototype.update=function(a){this.handleEvent(a);this.exec("onUpdate",arguments);this.updateChildren(a);this.exec("_update",arguments);this.exec("afterUpdate",arguments)};Scene.prototype.pause=function(){this.exec("onPause",arguments);var a=this.children();a&&a.forEach(function(a){exec(a,"pause")});this.exec("_pause",arguments);this.exec("afterPause",arguments)};Scene.prototype.stop=function(){this.pause()};Scene.prototype.resume=function(){forEach(this.children(),function(a){exec(a,"resume")})};
Scene.prototype.handleEvent=function(){};function Layer(){Node.apply(this,arguments)}Layer.prototype=new BaseObject;Layer.prototype.init=function(a,b){this.width(a||getDom().width);this.height(b||getDom().height);this.exec("onInit");this.exec("resume");this.exec("afterInit")};Layer.prototype.clear=function(){this.exec("onClear");this.unSubscribe();this.children().forEach(function(a){exec(a,"clear")});this.exec("afterClear")};
Layer.prototype.handleEvent=function(){this.exec("onHandleEvent");EventSystem.handleEventWithTarget(this);this.exec("_handleEvent");this.exec("afterHandleEvent")};Layer.prototype.removeChild=function(a){this.children().some(function(b,c,d){if(b===a)return d.splice(c,1),!0})};Layer.prototype.removeChildByTag=function(a){this.children().some(function(b,c,d){if(b.tag===a)return d.splice(c,1),!0})};
Layer.prototype.update=function(a){this.handleEvent(a);this.exec("onUpdate",a);this.exec("_update",a);this.updateChildren(a);this.render(a);this.exec("afterUpdate",a)};Layer.prototype.render=function(a){this.exec("onRender",a);this.exec("_render",a);this.exec("afterRender",a)};function Sprite(){Node.apply(this,arguments)}Sprite.prototype=new BaseObject;(function(){function a(){}"onInit _init afterInit onUpdate _update afterUpdate onRender _render afterRender onClear _clear afterClear onHandleEvent _handleEvent afterHandleEvent".split(" ").some(function(b){Sprite.prototype[b]=a})})();Sprite.prototype.init=function(){this.onInit.apply(this,arguments);this._init.apply(this,arguments);this.afterInit.apply(this,arguments)};
Sprite.prototype.update=function(a){this.handleEvent(a);this.onUpdate(a);this.performAction(a);this.performTransform(a);this._update(a);this.updateChildren(a);this.render(a);this.afterUpdate(a);a.setTransform(1,0,0,1,0,0);a.globalAlpha=1};Sprite.prototype.render=function(a){this.onRender(a);this._render(a);this.afterRender(a)};Sprite.prototype.clear=function(){this.onClear.apply(this,arguments);this._clear(this,arguments);this.afterClear(this,arguments)};
Sprite.prototype._render=function(a){if(this.getImage())this.drawWithImage(a,this.getImage());else return this.draw(a)};
Sprite.prototype.performTransform=function(a){a.globalAlpha=this.alpha();a.translate(this.actualPosition().x+this.width()*this.anchor().x,this.actualPosition().y+this.height()*this.anchor().y);this.rotate()&&a.rotate(this.rotate());(1!==this.skew().x||1!==this.skew().y)&&a.transform(1,Math.tan(this.skew().y),Math.tan(this.skew().x),1,0,0);(1!==this.scale().x||1!==this.scale().y)&&a.scale(this.scale().x,this.scale().y);this.transform()&&6<=this.transform().length&&a.transform(this.transform()[0],this.transform()[1],
this.transform()[2],this.transform()[3],this.transform()[4],this.transform()[5]);a.translate(-this.actualPosition().x-this.width()*this.anchor().x,-this.actualPosition().y-this.height()*this.anchor().y)};Sprite.prototype.performAction=function(){exec(this.actionManager,"update")};Sprite.prototype.drawWithImage=function(a,b){var c=b.size,d=this.actualPosition();this.scale();c?a.drawImage(b.img,c[0],c[1],c[2],c[3],d.x,d.y,c[2],c[3]):a.drawImage(b.img,d.x,d.y)};Sprite.prototype.draw=function(){};
Sprite.prototype.handleEvent=function(){this.onHandleEvent();EventSystem.handleEventWithTarget(this);this._handleEvent();this.afterHandleEvent()};function ActionManager(){this.init.apply(this,arguments)}ActionManager.prototype=new BaseObject;ActionManager.prototype.init=function(a){this.exec("onInit");this.target=a;this.addActionManagerSupport();this.exec("_init");this.exec("afterInit")};ActionManager.prototype.clear=function(){this.exec("onClear");this.exec("removeActionManagerSupport");this.exec("afterClear")};ActionManager.prototype.removeActionManagerSupport=function(){this.actions(null);for(var a in this)this[a]=null};
ActionManager.prototype.addActionManagerSupport=function(){this.actions=prop([]);this.actionsWithoutEmpty=function(){return this.actions()&&this.actions().removeNullVal()};this.addAction=function(a){return(this.actions()||this.resetActions()).push(a),this.actions()};this.resetActions=function(){return this.actions([])};this.runAction=function(a){this.actions().push(a);a.startWithTarget(this.target)};this.actionIndex=prop(0)};
ActionManager.prototype.update=function(){var a=!1;forEach(this.actions(),function(b,c,d){if(b.done())exec(b,"emitCallback"),d[c]=null,a=!0;else return b.step(1E3/60),!0});a&&this.actions().removeNullVal()};function Action(){this.done=prop(!1);this.callback=prop([]);this.pause=prop(!1);this.elapsed=0;this._preInit.apply(this,arguments);this.init.apply(this,arguments)}Action.prototype=new BaseObject;(function(){function a(){}"onInit _init _preInit afterInit onUpdate _update afterUpdate onReset _reset afterReset onClear _clear afterClear _startWithTarget".split(" ").some(function(b){Action.prototype[b]=a})})();Action.prototype.step=function(a){!this.pause()&&(!this.done()&&this.target)&&this.update(a)};
Action.prototype.emitCallback=function(){forEach(this.callback(),function(a){a&&a()});this.callback(null)};Action.prototype.stop=function(){this.pause(!0)};Action.prototype.resume=function(){this.pause(!1)};Action.prototype.currentAction=function(){return this};Action.prototype.reset=function(){this.done(!1);this.elapsed=0;this.onReset.apply(this,arguments);this._reset.apply(this,arguments);this.afterReset.apply(this,arguments)};
Action.prototype.clear=function(){this.onClear.apply(this,arguments);this._clear.apply(this,arguments);delete this.target;this.afterClear.apply(this,arguments)};Action.prototype._preInit=function(){2<=arguments.length&&(this.duration=arguments[1]);if(2<arguments.length){var a=this.callback();forEach(slice(arguments,2),function(b){a.push(b)})}};Action.prototype.init=function(){this.onInit.apply(this,arguments);this._init.apply(this,arguments);this.afterInit.apply(this,arguments)};
Action.prototype.update=function(a){a=this.currentTime(a);this.onUpdate.call(this,a);this._update.call(this,a);this.afterUpdate.call(this,a);this.checkDone()};Action.prototype.checkDone=function(){this.elapsed>=this.duration&&(this.done(!0),this.emitCallback())};Action.prototype.startWithTarget=function(a){this.target=a;this._startWithTarget.apply(this,arguments);this.step(1E3/60)};Action.prototype.currentTime=function(a){return Math.min(this.elapsed+=a,this.duration)};
Action.prototype.getTime=function(a){return a/this.duration};function MoveTo(){Action.apply(this,arguments)}MoveTo.prototype=new Action;MoveTo.prototype._init=function(a){this.toPosition=a};MoveTo.prototype._startWithTarget=function(){this.startPosition=this.target.position();this.deltaPosition=PointDiff(this.toPosition,this.startPosition)};MoveTo.prototype._update=function(a){this.target.position(PointSum(this.startPosition,PointMulti(this.deltaPosition,this.getTime(a))))};
MoveTo.prototype._reset=function(){};MoveTo.prototype._clear=function(){delete this.toPosition;delete this.startPosition;delete this.deltaPosition};function MoveBy(){Action.apply(this,arguments)}MoveBy.prototype=new Action;MoveBy.prototype._init=function(){MoveTo.prototype._init.apply(this,arguments)};MoveBy.prototype._startWithTarget=function(){this.startPosition=this.target.position();this.deltaPosition=this.toPosition};MoveBy.prototype._update=function(){MoveTo.prototype._update.apply(this,arguments)};
MoveBy.prototype._reset=function(){this.startPosition=PointSum(this.startPosition,this.deltaPosition)};MoveBy.prototype._clear=function(){MoveTo.prototype._clear.apply(this,arguments)};function ScaleTo(){Action.apply(this,arguments)}ScaleTo.prototype=new Action;ScaleTo.prototype._init=function(a){this.scaleTo=a};ScaleTo.prototype._startWithTarget=function(){this.startScale=this.target.scale();this.deltaScale=this.scaleTo.diff(this.startScale)};
ScaleTo.prototype._update=function(a){this.target.scale().addself(this.startScale,this.deltaScale.multi(this.getTime(a)))};ScaleTo.prototype._reset=function(){};ScaleTo.prototype._clear=function(){delete this.scaleTo;delete this.startScale;delete this.deltaScale};function ScaleBy(){Action.apply(this,arguments)}ScaleBy.prototype=new Action;ScaleBy.prototype._init=function(){ScaleTo.prototype._init.apply(this,arguments)};
ScaleBy.prototype._startWithTarget=function(){this.startScale=this.target.scale();this.deltaScale=this.scaleTo};ScaleBy.prototype._update=function(){ScaleTo.prototype._update.apply(this,arguments)};ScaleBy.prototype._reset=function(){ScaleTo.prototype._reset.apply(this,arguments)};ScaleBy.prototype._clear=function(){ScaleTo.prototype._clear.apply(this,arguments)};function SkewTo(){Action.apply(this,arguments)}SkewTo.prototype=new Action;SkewTo.prototype._init=function(a){this.skewTo=a};
SkewTo.prototype._startWithTarget=function(){this.startSkew=this.target.skew();this.deltaSkew=this.skewTo.diff(this.startSkew)};SkewTo.prototype._update=function(a){this.target.skew(this.startSkew.add(this.deltaSkew.multi(this.getTime(a))))};function SkewBy(){Action.apply(this,arguments)}SkewBy.prototype=new Action;SkewBy.prototype._init=function(a){this.deltaSkew=a};SkewBy.prototype._startWithTarget=function(){this.startSkew=this.target.skew()};
SkewBy.prototype._update=function(){SkewTo.prototype._update.apply(this,arguments)};function RotateTo(){Action.apply(this,arguments)}RotateTo.prototype=new Action;RotateTo.prototype._init=function(a){this.rotateTo=a};RotateTo.prototype._startWithTarget=function(){this.startRotate=this.target.rotate();this.deltaRotate=this.rotateTo-this.startRotate};RotateTo.prototype._update=function(a){this.target.rotate(this.startRotate+this.deltaRotate*this.getTime(a))};RotateTo.prototype._reset=function(){};
RotateTo.prototype._clear=function(){delete this.rotateTo;delete this.startRotate;delete this.deltaRotate};function RotateBy(){Action.apply(this,arguments)}RotateBy.prototype=new Action;RotateBy.prototype._init=function(){RotateTo.prototype._init.apply(this,arguments)};RotateBy.prototype._startWithTarget=function(){this.startRotate=this.target.rotate();this.deltaRotate=this.rotateTo};RotateBy.prototype._update=function(){RotateTo.prototype._update.apply(this,arguments)};
RotateBy.prototype._reset=function(){RotateTo.prototype._reset.apply(this,arguments)};RotateBy.prototype._clear=function(){RotateTo.prototype._clear.apply(this,arguments)};function FadeTo(){Action.apply(this,arguments)}FadeTo.prototype=new Action;FadeTo.prototype._init=function(a){this.fadeTo=a};FadeTo.prototype._startWithTarget=function(){this.startFade=this.target.alpha();this.deltaFade=this.fadeTo-this.startFade};
FadeTo.prototype._update=function(a){this.target.alpha(this.startFade+this.deltaFade*a)};FadeTo.prototype._reset=function(){};FadeTo.prototype._clear=function(){delete this.fadeTo;delete this.startFade;delete this.deltaFade};function FadeBy(){Action.apply(this,arguments)}FadeBy.prototype=new Action;FadeBy.prototype._init=function(){FadeTo.prototype._init.apply(this,arguments)};FadeBy.prototype._startWithTarget=function(){this.startFade=this.target.alpha();this.deltaFade=this.fadeTo};
FadeBy.prototype._update=function(a){this.target.alpha(this.startFade+this.deltaFade*a)};FadeBy.prototype._reset=function(){FadeTo.prototype._reset.apply(this,arguments)};function FadeIn(){Action.apply(this,arguments)}FadeIn.prototype=new Action;FadeIn.prototype._init=function(){this.fadeTo=1};FadeIn.prototype._startWithTarget=function(){FadeTo.prototype._startWithTarget.apply(this,arguments)};FadeIn.prototype._update=function(){FadeTo.prototype._update.apply(this,arguments)};
FadeIn.prototype._reset=function(){FadeTo.prototype._reset.apply(this,arguments)};FadeIn.prototype._clear=function(){FadeTo.prototype._clear.apply(this,arguments)};function FadeOut(){Action.apply(this,arguments)}FadeOut.prototype=new Action;FadeOut.prototype._preInit=function(){};FadeOut.prototype._init=function(a){this.fadeTo=0;this.duration=a;var b=this.callback();forEach(slice(arguments,1),function(a){b.push(a)})};
FadeOut.prototype._startWithTarget=function(){FadeIn.prototype._startWithTarget.apply(this,arguments)};FadeOut.prototype._update=function(){FadeIn.prototype._update.apply(this,arguments)};FadeOut.prototype._reset=function(){FadeTo.prototype._reset.apply(this,arguments)};FadeOut.prototype._clear=function(){FadeTo.prototype._clear.apply(this,arguments)};function Delay(){Action.apply(this,arguments)}Delay.prototype=new Action;Delay.prototype._preInit=function(){};
Delay.prototype._init=function(a){this.duration=a;var b=this.callback();forEach(slice(arguments,1),function(a){b.push(a)})};function Sequence(){Action.apply(this,arguments)}Sequence.prototype=new Action;Sequence.prototype._preInit=function(){};Sequence.prototype._init=function(){var a=[];this.actions=function(b){return void 0===b?a:a=b};var b=this.actions();forEach(arguments,function(a){b.push(a)})};Sequence.prototype._update=function(a){exec(this.currentAction(),"update",a)};
Sequence.prototype.currentTime=function(a){return a};Sequence.prototype.checkDone=function(){var a=!0;forEach(this.actions(),function(b){if(!b.done())return a=!1,!0});a&&this.emitCallback();return a};Sequence.prototype.currentAction=function(){for(var a=this.actions(),b=a.length-1;0<=b;b--)a[b].done()&&a.splice(b,1);if(a.length){if(a[0].target)return a[0];a[0].startWithTarget(this.target)}};function Repeat(){Action.apply(this,arguments)}Repeat.prototype=new Action;Repeat.prototype._preInit=function(){};
Repeat.prototype._init=function(a,b){this.action=a;this.repeatTotal=b;this.hasRepeated=0};Repeat.prototype.checkDone=function(){if(this.hasRepeated>=this.repeatTotal)return!0};Repeat.prototype._update=function(a){exec(this.currentAction(),"update",a);this.action.done()&&(this.hasRepeated++,this.done(this.hasRepeated>=this.repeatTotal))};Repeat.prototype.currentTime=function(a){return a};
Repeat.prototype.currentAction=function(){this.hasRepeated<this.repeatTotal&&this.action.done()&&this.action.reset();if(this.action.target)return this.action;this.action.startWithTarget(this.target)};Repeat.prototype._reset=function(){};Repeat.prototype._clear=function(){this.actions(null)};function Spawn(){Action.apply(this,arguments)}Spawn.prototype=new Action;Spawn.prototype._init=function(){var a=[];this.actions=function(b){return void 0===b?a:a=b};var b=this.actions();forEach(arguments,function(a){b.push(a)})};
Spawn.prototype._preInit=function(){};Spawn.prototype._update=function(a){var b=this;forEach(b.actions(),function(c){c.target?c.update(a):c.startWithTarget(b.target)})};Spawn.prototype.currentTime=function(a){return a};Spawn.prototype.checkDone=function(){var a=!0,b=this,c=!1;forEach(b.actions(),function(d,e){if(d.done())c=!0,b.actions()[e]=null;else return a=!1,!0});a&&this.done(!0);c&&this.actions().removeNullVal();return a};function RepeatForever(){Action.apply(this,arguments)}
RepeatForever.prototype=new Action;RepeatForever.prototype._init=function(a){this.action=a};RepeatForever.prototype._preInit=function(){};RepeatForever.prototype._update=function(){this.action._update.apply(this.action,arguments)};RepeatForever.prototype._reset=function(){};RepeatForever.prototype._clear=function(){this.action=null};RepeatForever.prototype.currentAction=function(){return this.action};RepeatForever.prototype.done=function(){return this.action.done.apply(this.action,arguments)};
RepeatForever.prototype.checkDone=function(){return!1};RepeatForever.prototype._update=function(a){exec(this.currentAction(),"update",a);this.action.done()};RepeatForever.prototype.currentTime=function(a){return a};RepeatForever.prototype.currentAction=function(){this.action.done()&&this.action.reset();if(this.action.target)return this.action;this.action.startWithTarget(this.target)};function CustomerAction(){Action.apply(this,arguments)}CustomerAction.prototype=new Action;
CustomerAction.prototype._init=function(a){this.to=a};CustomerAction.prototype._startWithTarget=function(){forEach(this.to,function(a,b){this["start"+b]=this.target[b]();this["delta"+b]=isNumber(a)?a-this.target[b]():a.diff(this.target[b]())},this)};
CustomerAction.prototype._update=function(a){forEach(this.to,function(b,c){var d=this.getTime(a);if(isNumber(b))this.target[c](this["start"+c]+this["delta"+c]*d);else this.target[c](this["start"+c].sum(this["delta"+c].multi(d))),console.log(this["start"+c].sum(this["delta"+c].multi(d)))},this)};CustomerAction.prototype._reset=function(){};var Easing={easeInQuad:function(a,b){return(a/=b)*a},easeOutQuad:function(a,b){return-(a/=b)*(a-2)},easeInOutQuad:function(a,b){return 1>(a/=b/2)?0.5*a*a:-0.5*(--a*(a-2)-1)},easeInCubic:function(a,b){return(a/=b)*a*a},easeOutCubic:function(a,b){return(a=a/b-1)*a*a+1},easeInOutCubic:function(a,b){return 1>(a/=b/2)?0.5*a*a*a:0.5*((a-=2)*a*a+2)},easeInQuart:function(a,b){return(a/=b)*a*a*a},easeOutQuart:function(a,b){return-((a=a/b-1)*a*a*a-1)},easeInOutQuart:function(a,b){return 1>(a/=b/2)?0.5*a*a*
a*a:-0.5*((a-=2)*a*a*a-2)},easeInQuint:function(a,b){return(a/=b)*a*a*a*a},easeOutQuint:function(a,b){return(a=a/b-1)*a*a*a*a+1},easeInOutQuint:function(a,b){return 1>(a/=b/2)?0.5*a*a*a*a*a:0.5*((a-=2)*a*a*a*a+2)},easeInSine:function(a,b){return 1-Math.cos(a/b*(Math.PI/2))},easeOutSine:function(a,b){return Math.sin(a/b*(Math.PI/2))},easeInOutSine:function(a,b){return-0.5*(Math.cos(Math.PI*a/b)-1)},easeInExpo:function(a,b){return 0==a?1:Math.pow(2,10*(a/b-1))},easeOutExpo:function(a,b){return a==b?
1:-Math.pow(2,-10*a/b)+1},easeInOutExpo:function(a,b){return 0==a?0:a==b?1:1>(a/=b/2)?0.5*Math.pow(2,10*(a-1)):0.5*(-Math.pow(2,-10*--a)+2)},easeInCirc:function(a,b){return-(Math.sqrt(1-(a/=b)*a)-1)},easeOutCirc:function(a,b){return Math.sqrt(1-(a=a/b-1)*a)},easeInOutCirc:function(a,b){return 1>(a/=b/2)?-0.5*(Math.sqrt(1-a*a)-1):0.5*(Math.sqrt(1-(a-=2)*a)+1)},easeInElastic:function(a,b){if(0==a)return 0;if(1==(a/=b))return 1;var c=0.3*b,d=c/4;return-(1*Math.pow(2,10*(a-=1))*Math.sin((a*b-d)*2*Math.PI/
c))},easeOutElastic:function(a,b){if(0==a)return 0;if(1==(a/=b))return 1;var c=0.3*b,d=c/4;return 1*Math.pow(2,-10*a)*Math.sin((a*b-d)*2*Math.PI/c)+1},easeInOutElastic:function(a,b){if(0==a)return 0;if(2==(a/=b/2))return 1;var c=b*0.3*1.5,d=c/4;return 1>a?-0.5*1*Math.pow(2,10*(a-=1))*Math.sin((a*b-d)*2*Math.PI/c):0.5*1*Math.pow(2,-10*(a-=1))*Math.sin((a*b-d)*2*Math.PI/c)+1},easeInBack:function(a,b){return(a/=b)*a*(2.70158*a-1.70158)},easeOutBack:function(a,b){return(a=a/b-1)*a*(2.70158*a+1.70158)+
1},easeInOutBack:function(a,b){var c=1.70158;return 1>(a/=b/2)?0.5*a*a*(((c*=1.525)+1)*a-c):0.5*((a-=2)*a*(((c*=1.525)+1)*a+c)+2)},easeInBounce:function(a,b){return 1-this.easeOutBounce(b-a,b)},easeOutBounce:function(a,b){return(a/=b)<1/2.75?7.5625*a*a:a<2/2.75?7.5625*(a-=1.5/2.75)*a+0.75:a<2.5/2.75?7.5625*(a-=2.25/2.75)*a+0.9375:7.5625*(a-=2.625/2.75)*a+0.984375},easeInOutBounce:function(a,b){return a<b/2?0.5*this.easeInBounce(2*a,b):0.5*this.easeOutBounce(2*a-b,b)+0.5},withAction:function(a,b){b&&
(a.getTime=function(a){return Easing[b](a,this.duration)});return a}};var EventSystem={eventsType:["mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave".split(" "),["keydown","keypress","keyup"],["touchstart","touchmove","touchend","touchcancel"]],init:function(){function a(a){if(a&&!c.deallingEvents())for(var e in b)if(0==a.type.indexOf(e)){b[e].call(c,a);break}}var b={mouse:function(a){this.events()[0].some(function(){});this.events()[0].removeNullVal();a.position={x:null!=a.offsetX?a.offsetX:a.pageX-a.target.offsetLeft,y:null!=a.offsetY?a.offsetY:
a.pageY-a.target.offsetTop};this.events()[0].push(a)},key:function(){Debugger.error("this function need to be implmented")},touch:function(a){this.events()[2].some(function(){});this.events()[2].removeNullVal();var b=a.touches[0];a.position={x:b?b.pageX-b.target.offsetLeft:0,y:b?b.pageY-b.target.offsetTop:0};this.events()[2].push(a)}},c=this;this.eventsType.forEach(function(b){b.forEach(function(b){addEventHandler(getDom(),b,a)})});this.resetEvents()},removeEvent:function(a){this.events().some(function(b){return b.some(function(b,
d,e){if(b===a)return e.splice(d,1),!0})})}};EventSystem.events=function(){var a=[[],[],[]];return function(b){return void 0===b?a:a=b}}();EventSystem.deallingEvents=function(){var a;return function(b){return void 0===b?a:a=b}}();EventSystem.resetEvents=function(){this.events([[],[],[]]);this.deallingEvents(!1)};
EventSystem.handleEventWithTarget=function(a){forEach(EventSystem.events()[0],function(b){b.position.x>=a.actualPosition().x&&(b.position.x<=a.actualPosition().x+a.width()&&b.position.y>=a.actualPosition().y&&b.position.y<=a.actualPosition().y+a.height())&&forEach(a["on"+b.type],function(c){c.call(a,b)})});forEach(EventSystem.events()[1],function(){});forEach(EventSystem.events()[2],function(b){b.position.x>=a.actualPosition().x&&(b.position.x<=a.actualPosition().x+a.width()&&b.position.y>=a.actualPosition().y&&
b.position.y<=a.actualPosition().y+a.height())&&forEach(a["on"+b.type],function(c){c.call(a,b)})})};var Handler=function(a,b){if(!a||!(this instanceof Handler))return null;this.handler=a;this.target=b},MessageCenter={topics:[],handlers:{},trigger:function(a){this.handlers[a]&&this.handlers[a].forEach(function(a){a&&a.handler&&a.handler.call(a.target)})},_existTopic:function(a){return this.topics.some(function(b){return a===b})},_existHandler:function(a,b,c){return this.handlers[a]&&this.handlers[a].some(function(a){return a&&a.handler===b&&a.target===c})},onPublish:function(a){a&&(this._existTopic(a)||
this.topics.push(a),this.trigger(a))},onSubscribe:function(a,b,c){a&&(this.handlers[a]||(this.handlers[a]=[]),this._existHandler(a,b,c)||this.handlers[a].push(new Handler(b,c)))},onUnSubscribe:function(a,b,c){if(a)if(b&&c)this.handlers[b]&&this.handlers[b].forEach(function(b,d,g){b&&(b.handler===c&&b.target===a)&&(g[d]=null)}),this.handlers[b].removeNullVal();else if(b&&!c)this.handlers[b]&&this.handlers[b].forEach(function(b,c,d){b&&b.target===a&&(d[c]=null)}),this.handlers[b].removeNullVal();else if(!b&&
c)for(var d in this.handlers)this.handlers[d]&&this.handlers[d].forEach(function(b,c,d){b&&b.target===a&&(d[c]=null)}),this.handlers[d].removeNullVal();else if(!b&&!c)for(d in this.handlers)this.handlers.hasOwnProperty(d)&&(this.handlers[d]&&this.handlers[d].forEach(function(b,c,d){b&&b.target===a&&(d[c]=null)}),this.handlers[d].removeNullVal())},clearTopic:function(a){this.topics.forEach(function(b,c,d){b===a&&(d[c]=null)})},clearSubscribe:function(a,b){for(var c in this.handlers)this.handlers[c]&&
this.handlers[c].forEach(function(a,c,f){a&&a.handler===b&&(f[c]=null)}),this.handlers[c].removeNullVal()}};function PointMake(a,b){return new Point(a,b)}function PointZero(){return PointMake(0,0)}function PointEqual(a,b){return a===b||a.x===b.x&&a.y===b.y}function PointInRect(a,b){return a&&b&&a.x>b.x&&a.x<b.x+b.w&&a.y>b.y&&a.y<b.y+b.h}function PointSum(a,b){return a.sum(b)}function PointDiff(a,b){return a.diff(b)}function PointMulti(a,b){return a.multi(b)}function PointDevide(a,b){return a.devide(b)}function Point(a,b){this.x=a;this.y=b}
Point.prototype.distanceTo=function(a){return Math.sqrt((this.x-a.x)*(this.x-a.x)+(this.y-a.y)*(this.y-a.y))};Point.prototype.sum=function(a){return PointMake(this.x+a.x,this.y+a.y)};Point.prototype.multi=function(a){return PointMake(this.x*a,this.y*a)};Point.prototype.devide=function(a){return PointMake(this.x/a,this.y/a)};Point.prototype.diff=function(a){return PointMake(this.x-a.x,this.y-a.y)};Point.prototype.add=function(a){this.x+=a.x;this.y+=a.y;return this};
Point.prototype.multi2=function(a){this.x*=a;this.y*=a;return this};Point.prototype.devide2=function(a){this.x/=a;this.y/=a;return this};Point.prototype.diff2=function(a){this.x-=a.x;this.y-=a.y;return this};Point.prototype.reset=function(a,b){this.x=a||0;this.y=b||0;return this};Point.prototype.sub=function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;return this};Point.prototype.addself=function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;return this};function Matrix(a){var b=this;a.some(function(a){push(b,a)})}Matrix.prototype.multi=function(a){for(i=0;i<this.length;++i)for(k=0;k<this.length;++k){var b=this[i][k];for(j=0;j<this.length;++j)this[i][j]+=b*a[k][j]}return this};Matrix.prototype.multiNew=function(a){var b=new Matrix([]);for(i=0;i<this.length;++i)for(k=0;k<this.length;++k){r=this[i][k];for(j=0;j<this.length;++j)b[i]=b[i]||[],b[i][j]+=r*a[k][j]}return b};function SizeMake(a,b){return{w:a,h:b}}function SizeZero(){return SizeMake(0,0)}function SizeEqual(a,b){return a===b||a.w===b.w&&a.h===b.h};function RectMakeBy2Points(a,b){return RectMakeByPointAndSize(PointMake(Math.min(a.x,b.x),Math.min(a.y,b.y)),SizeMake(Math.abs(a.x-b.x),Math.abs(a.y-b.y)))}function RectMake(){return new Rect(leftTopPoint.x,leftTopPoint.y,size.w,size.h)}function RectMakeByPointAndSize(a,b){return new Rect(a.x,a.y,b.w,b.h)}function RectZero(){return RectMake(0,0,0,0)}function getRectMidPoint(a){return PointMake(a.x+a.w/2,a.y+a.h/2)}function RectEqual(a,b){return a.x===b.x&&a.y===b.y&&a.w===b.w&&a.h===b.h}
function Rect(a,b,c,d){this.x=a;this.y=b;this.w=c;this.h=d}Rect.prototype.right=function(){return this.x+this.w};Rect.prototype.left=function(){return this.x};Rect.prototype.top=function(){return this.y};Rect.prototype.bottom=function(){return this.y+this.h};var Base64Binary={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",decodeArrayBuffer:function(a){var b=new ArrayBuffer(3*(a.length/4));this.decode(a,b);return b},decode:function(a,b){var c=this._keyStr.indexOf(a.charAt(a.length-1)),d=this._keyStr.indexOf(a.charAt(a.length-2)),e=3*(a.length/4);64==c&&e--;64==d&&e--;for(var f,g,l,n,h=0,m=0,c=b?new Uint8Array(b):new Uint8Array(e),a=a.replace(/[^A-Za-z0-9\+\/\=]/g,""),h=0;h<e;h+=3)f=this._keyStr.indexOf(a.charAt(m++)),g=this._keyStr.indexOf(a.charAt(m++)),
d=this._keyStr.indexOf(a.charAt(m++)),n=this._keyStr.indexOf(a.charAt(m++)),f=f<<2|g>>4,g=(g&15)<<4|d>>2,l=(d&3)<<6|n,c[h]=f,64!=d&&(c[h+1]=g),64!=n&&(c[h+2]=l);return c}};function AudioLoad(a,b){var c=document.createElement("audio");c.autoplay=!1;c.preload="auto";c.src=a;addEventHandler(c,"canplaythrough",function(){this.loaded=!0;emitCallback.call(this)});setCallback.call(c,b);return c};var audioBufferCache=[],audioContext;
function WebAudioLoad(a,b){var c=a+".js";audioContext=audioContext||new (window.AudioContext||window.webkitAudioContext);if(audioBufferCache[c])return(new WebAudio(c,b)).setBuffer(audioBufferCache[c]);var d=a.substring(a.lastIndexOf("/")+1),e;if(e=document.getElementById(d)){var f=new WebAudio;e.loadedCallback.push(function(){f.setBuffer(audioBufferCache[c])})}else e=ScriptLoad(c,function(){f.setArrayBuffer(Base64Binary.decodeArrayBuffer(AudioEngine[d]),function(a){audioBufferCache[c]=a;forEach(e.loadedCallback,
function(a){a&&a.call(e);e.loadedCallback=null})})}),e.id=d,f=new WebAudio(function(){delete AudioEngine[d];e.parentNode.removeChild(e)});return f}function WebAudio(a){this.source=audioContext.createBufferSource();this.source.connect(audioContext.destination);setCallback.call(this,a)}WebAudio.prototype.setArrayBuffer=function(a,b){var c=this;audioContext.decodeAudioData(a,function(a){c.setBuffer(a);b&&b(a)})};
WebAudio.prototype.setBuffer=function(a){this.source.buffer=a;this.loaded=!0;emitCallback.call(this);return this};WebAudio.prototype.play=function(){this.source.noteOn(0);return this};WebAudio.prototype.stop=function(){this.source.noteOff(0);return this};function ScriptLoad(a,b){function c(){forEach(d.callback,function(a){a&&a.call(d)})}var d=document.createElement("script");d.type="text/javascript";d.src=a;d.onreadystatechange=function(){"complete"==this.readyState&&c()};d.callback=[];isArray(b)?forEach(b,function(a){d.callback.push(a)}):b&&d.callback.push(b);d.onload=c;(document.head||document.body).appendChild(d);d.loadedCallback=[];return d};var AudioEngine=function(){function a(a,b,f){var g=c[a+"."+b];if(g)return isArray(f)?g.loaded?forEach(f,function(a){a&&a.call(g)}):forEach(f,function(a){g.callback.push(a)}):g.loaded?f&&f.call(g):f&&g.callback.push(fn),"mp3"===b||"ogg"===b?g.cloneNode(!0):g;var l=a+"."+b,a="mp3"===b||"ogg"===b?c[l]=AudioLoad(l,f):WebAudioLoad(a,f);return a}var b={};navigator.userAgent.indexOf("iPad");navigator.userAgent.indexOf("MSIE");-1!=navigator.userAgent.indexOf("Safari")&&navigator.userAgent.indexOf("Chrome");
var c=[];b.canPlayMP3=!1;b.canPlayOGG=!1;b.loadAudio=function(b,c){return this.canPlayMP3?a(b,"mp3",c):this.canPlayOGG?a(b,"ogg",c):a(b,"js",c)};return b}();var ImageEngine=function(){var a=[];return{loadImage:function(b,c){var d=a[b];if(d)return d.loaded?isArray(c)?forEach(c,function(a){a&&a.call(d)}):c&&c.call(d):isArray(c)?forEach(c,function(a){d.callback.push(a)}):c&&d.callback.push(c),d;var e=new Image;e.src=b;e.callback=[];isArray(c)?forEach(c,function(a){e.callback.push(a)}):c&&e.callback.push(c);e.onload=function(){this.loaded=!0;forEach(this.callback,function(a){a&&a.call(e)});e.callback=[]};return e}}}();function Force(a,b,c){this.value=prop(PointMake(a,b));this.life=c||Infinity}Force.prototype.isActive=function(){if(0>=this.life)return this.destory(),!1;this.update();return!0};Force.prototype.update=function(){};function Gravity(a){Force.call(this,0,a,Infinity)}Gravity.prototype=new Force;function Brownian(a,b,c){Force.call(this,0,0,c);this.maxValue=a;this.cycle=b;this.pastTime=0;this.value().reset((2*Math.random()-1)*this.maxValue,(2*Math.random()-1)*this.maxValue)}Brownian.prototype=new Force;
Brownian.prototype.update=function(){this.pastTime+=0.004;this.pastTime>=this.cycle&&(this.value().reset((2*Math.random()-1)*this.maxValue,(2*Math.random()-1)*this.maxValue),this.pastTime=0)};function Attraction(a,b,c,d){Force.call(this,0,0,d);this.maxValue=b;this.r=c;this.attractionPosition=a;this.target=null}Attraction.prototype=new Force;
Attraction.prototype.update=function(){var a=this.attractionPosition.distanceTo(this.target.position());a<this.r?this.value().sub(this.target.position(),this.attractionPosition):this.value().sub(this.attractionPosition,this.target.position());this.value().multi2(this.maxValue/a)};function Repulsion(a,b,c,d){Force.call(this,0,0,d);this.maxValue=b;this.r=c;this.repulsionPosition=a;this.target=null}Repulsion.prototype=new Force;
Repulsion.prototype.update=function(){var a=this.repulsionPosition.distanceTo(this.target.position());a>this.r?this.value().reset(0,0):this.value(this.target.position().diff(this.repulsionPosition).multi(this.maxValue/(a||1)))};function Particle(a,b,c){this.position=prop(a||PointMake(0,0));this.velocity=prop(PointMake(0,0));this.damp=prop(PointMake(0.1,0.1));this.resultant=prop(PointMake(0,0));this.life=prop(void 0===b?b:Infinity);this.forcesMap=prop([]);this.image=prop(c);this.boundary=prop();this.bounceIntensity=2;this.boundaryType=this.offscreen;this.scale=1;this.rotation=0;this.alpha=1}Particle.prototype.render=function(a){this.onRender(a);this.image()?this._render(a):this.draw(a);this.afterRender(a)};
Particle.prototype.update=function(a){0>=this.life()||(this.onUpdate(a),this._update(a),this.afterUpdate(a),this.resultant().reset(),forEach(this.forcesMap(),function(a,c,d){a.isActive()?this.resultant().add(a.value()):d[c]=null},this),this.forcesMap().removeNullVal(),this.velocity().add(this.resultant()),this.velocity().x*=1-this.damp().x,this.velocity().y*=1-this.damp().y,this.position().add(this.velocity()),null!=this.boundary()&&this.boundaryType(),this.render(a),this.life(this.life()-0.004))};
Particle.prototype._render=function(a){a.translate(this.position().x,this.position().y);var b=this.image().size;b?a.drawImage(this.image().img,b[0],b[1],b[2],b[3],0,0,b[2],b[3]):a.drawImage(this.image().img,0,0);a.setTransform(1,0,0,1,0,0)};Particle.prototype.draw=function(){};Particle.prototype.afterRender=function(){};Particle.prototype.onRender=function(){};Particle.prototype.onUpdate=function(){};Particle.prototype._update=function(){};Particle.prototype.afterUpdate=function(){};
Particle.prototype.reset=function(){this.position().reset();this.velocity().reset();this.damp().reset(0.1,0.1);this.resultant.reset();this.life(Infinity);this.forcesMap().length=0;this.bounceIntensity=2;this.boundaryType=this.offscreen;this.scale=1;this.rotation=0;this.alpha=1};
Particle.prototype.bounce=function(){var a=this.position(),b=this.boundary();a.x<b.left()?(a.x=b.left(),this.velocity().x*=-this.bounceIntensity):a.x>b.right()&&(a.x=b.right(),this.velocity().x*=-this.bounceIntensity);a.y<b.top()?(a.y=b.top(),this.velocity().y*=-this.bounceIntensity):a.y>b.bottom()&&(a.y=b.bottom(),this.velocity().y*=-this.bounceIntensity)};
Particle.prototype.offscreen=function(){var a=this.position(),b=this.boundary();a.x<b.left()&&(a.x=b.right());a.x>b.right()&&(a.x=b.left());a.y<b.top()&&(a.y=b.bottom());a.y>b.bottom()&&(a.y=b.top())};function ParticlePool(){var a=[];this.get=function(b){var c;forEach(a,function(d,e){if(d.type===b)return c=d,a.splice(e,1),!0});return c||new Particle(b)};this.recycle=function(b){a.push(b)};this.getParticles=function(){return a}};function ParticleSystem(){this.particles=prop([]);this.pool=new ParticlePool;this.createParticle=function(a){a=this.pool.get(a);this.particles().push(a);return a};this.update=function(a){var b=this.particles(),c=b.length;for(forEach(b,function(b){b.update(a)});0<c--;)0>=b[c].life&&(this.pool.recycle(b[c]),b.splice(c,1))}};
